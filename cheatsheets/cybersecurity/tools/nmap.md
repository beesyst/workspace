# Nmap

---

## Установка

### Debian / Ubuntu / Kali

```
sudo apt install nmap
```

### RHEL / Fedora / CentOS / Rocky

```
sudo dnf install nmap
```

### Windows

https://nmap.org/download

### macOS (Homebrew)

```
brew install nmap
```

## Базовые команды

| Команда                                    | Описание                                                                                |
| ------------------------------------------ | --------------------------------------------------------------------------------------- |
| `nmap -sP 10.0.0.0/24`                     | Пинг-скан сети: перечислит хосты, отвечающие на ping. *(Современный эквивалент: `-sn`)* |
| `nmap -p 1-65535 -sV -sS -T4 target`       | Полный TCP-скан с определением версий; скорость `T4`.                                   |
| `nmap -v -sS -A -T4 target`                | Подробный вывод, stealth SYN, ОС/версии, traceroute, скрипты.                           |
| `nmap -v -sS -A -T5 target`                | То же, но очень агрессивный `T5` (может пропускать порты).                              |
| `nmap -v -sV -O -sS -T5 target`            | SYN + версии + ОС, агрессивный тайминг.                                                 |
| `nmap -v -p 1-65535 -sV -O -sS -T4 target` | Полный диапазон портов + версии + ОС, `T4`.                                             |
| `nmap -v -p 1-65535 -sV -O -sS -T5 target` | То же, `T5`.                                                                            |

## Скан из файла

| Команда                                 | Описание                         |
| --------------------------------------- | -------------------------------- |
| `nmap -iL ip-addresses.txt [доп.опции]` | Сканы по списку целевых адресов. |

## Скан всех портов

| Команда           | Описание                  |
| ----------------- | ------------------------- |
| `nmap -p- target` | Скан **всех** TCP-портов. |


## Форматы вывода

| Команда                                                                      | Описание                                          |
| ---------------------------------------------------------------------------- | ------------------------------------------------- |
| `nmap -sS -sV -T5 10.0.1.99 -oA output-all-formats`                          | Вывод во все форматы: `-oN`, `-oX`, `-oG`.        |
| `nmap -sV -p 139,445 -oG grep-output.txt 10.0.1.0/24`                        | Grep-friendly вывод (для последующей фильтрации). |
| `nmap -sS -sV -T5 10.0.1.99 --webxml -oX - \| xsltproc --output file.html -` | Экспорт в HTML отчёт через XSLT.                  |

## NetBIOS и Nikto: быстрые примеры

| Команда                                                                  | Описание                                                                 |
| ------------------------------------------------------------------------ | ------------------------------------------------------------------------ |
| `nmap -sV -v -p 139,445 10.0.0.1/24`                                     | Найти NetBIOS/SMB-хосты в подсети.                                       |
| `nmap -sU --script nbstat.nse -p 137 target`                             | Узнать NetBIOS-имя (`nbstat`).                                           |
| `nmap --script-args=unsafe=1 --script smb-check-vulns.nse -p 445 target` | Проверка MS08-067 и др. **Осторожно:** `unsafe=1` может уронить сервисы. |
| `nmap -p80 10.0.1.0/24 -oG - \| nikto.pl -h -`                           | Найти HTTP:80 и сразу отдать их Nikto.                                   |
| `nmap -p80,443 10.0.1.0/24 -oG - \| nikto.pl -h -`                       | То же для 80/443.                                                        |

## Target Specification (задача целей)

| Ключ                    | Описание                           |
| ----------------------- | ---------------------------------- |
| `-iL <file>`            | Ввод списка хостов/сетей из файла. |
| `-iR <num>`             | Случайный выбор целей.             |
| `--exclude <h1,h2,...>` | Исключить хосты/сети.              |
| `--excludefile <file>`  | Исключить из файла.                |

## Host Discovery (обнаружение хостов)

| Ключ                  | Описание                                                   |
| --------------------- | ---------------------------------------------------------- |
| `-sL`                 | Только перечислить цели (без скана).                       |
| `-sn`                 | «Пинг-скан» (без портов).                                  |
| `-Pn`                 | Считать все хосты «в сети» (пропустить обнаружение).       |
| `-PS/PA/PU/PY[ports]` | TCP SYN/ACK, UDP, SCTP-пинги к указанным портам (`-PS22`). |
| `-PE/PP/PM`           | ICMP echo/timestamp/netmask.                               |
| `-PO[proto]`          | Ping по IP-протоколам.                                     |
| `-n` / `-R`           | Не резолвить DNS / всегда резолвить.                       |

## Scan Techniques (техники сканирования)

| Ключ                     | Описание                 |
| ------------------------ | ------------------------ |
| `-sS`                    | TCP SYN (stealth).       |
| `-sT`                    | TCP connect().           |
| `-sA`                    | ACK-скан.                |
| `-sW`                    | Window-скан.             |
| `-sM`                    | Maimon-скан.             |
| `-sU`                    | UDP-скан.                |
| `-sN` / `-sF` / `-sX`    | Null / FIN / Xmas.       |
| `--scanflags <flags>`    | Кастомные TCP-флаги.     |
| `-sI zombie[:probeport]` | Idle-скан.               |
| `-sY` / `-sZ`            | SCTP INIT / COOKIE-ECHO. |
| `-sO`                    | Скан IP-протоколов.      |
| `-b "ftp_relay"`         | FTP bounce-скан.         |

## Port Specification & Order (порты и порядок)

| Ключ                   | Описание                                          |
| ---------------------- | ------------------------------------------------- |
| `-p <spec>`            | Диапазоны/списки портов: `-p80,443`, `-p1-65535`. |
| `-p U:<port>`          | Явный UDP-порт (пример: `-p U:53`).               |
| `-F`                   | Быстрый режим (меньше портов).                    |
| `-r`                   | Последовательно, без рандома.                     |
| `--top-ports <N>`      | Скан N самых популярных портов.                   |
| `--port-ratio <ratio>` | Скан портов популярнее `ratio`.                   |

## Service Version Detection

| Ключ                        | Описание                              |
| --------------------------- | ------------------------------------- |
| `-sV`                       | Определение версий сервисов.          |
| `--version-intensity <0-9>` | 0 — «легкий», 9 — все пробы.          |
| `--version-light`           | Интенсивность 2 (наиболее вероятные). |
| `--version-all`             | Интенсивность 9 (все пробы).          |
| `--version-trace`           | Детализированный трейс версии.        |

## Script Scan (NSE)

| Ключ                        | Описание                              |
| --------------------------- | ------------------------------------- |
| `-sC`                       | Эквивалент `--script=default`.        |
| `--script=<list>`           | Список скриптов/категорий/директорий. |
| `--script-args k=v,...`     | Аргументы для NSE.                    |
| `--script-args-file <file>` | Аргументы из файла.                   |
| `--script-trace`            | Показать весь трафик скриптов.        |
| `--script-updatedb`         | Обновить базу скриптов.               |
| `--script-help=<list>`      | Справка по скриптам.                  |

## OS Detection

| Ключ             | Описание                                   |
| ---------------- | ------------------------------------------ |
| `-O`             | Детект ОС.                                 |
| `--osscan-limit` | Пытаться только на «перспективных» хостах. |
| `--osscan-guess` | Более агрессивные догадки.                 |

## Timing & Performance

Все значения времени: ms/s/m/h.

| Ключ                                                        | Описание                                         |
| ----------------------------------------------------------- | ------------------------------------------------ |
| `-T0..5`                                                    | Тайминг-шаблон (быстрее → менее точно).          |
| `--min-hostgroup/--max-hostgroup`                           | Размер групп хостов.                             |
| `--min-parallelism/--max-parallelism`                       | Параллелизм проб.                                |
| `--min-rtt-timeout/--max-rtt-timeout/--initial-rtt-timeout` | RTT-таймауты.                                    |
| `--max-retries <n>`                                         | Лимит ретраев проб.                              |
| `--host-timeout <time>`                                     | Бросить цель после времени.                      |
| `--scan-delay/--max-scan-delay`                             | Пауза между пробами.                             |
| `--min-rate/--max-rate`                                     | Минимальная/максимальная скорость пакетов в сек. |

## Firewalls / IDS Evasion & Spoofing

| Ключ                      | Описание                      |
| ------------------------- | ----------------------------- |
| `-f` / `--mtu <val>`      | Фрагментация пакетов (MTU).   |
| `-D decoy1,decoy2,ME`     | Декои/маскировка источника.   |
| `-S <ip>`                 | Подмена исходного IP.         |
| `-e <iface>`              | Явный интерфейс.              |
| `-g/--source-port <port>` | Фиксированный исходный порт.  |
| `--proxies url1[,url2]`   | Прокси (HTTP/SOCKS4).         |
| `--data-length <n>`       | Добивка случайными данными.   |
| `--ip-options <opts>`     | Опции IP.                     |
| `--ttl <val>`             | TTL.                          |
| `--spoof-mac <val>`       | Спуфинг MAC.                  |
| `--badsum`                | Поддельная контрольная сумма. |

## Output Options (файлы вывода)

| Ключ                | Описание                              | 
| ------------------- | ------------------------------------- | 
| `-oN/-oX/-oS/-oG`   | Normal / XML / 1337 / Grepable.       | 
| `-oA <basename>`    | Сразу все форматы.                    |
| `-v/-vv`            | Более подробный вывод.                | 
| `-d/-dd`            | Дебаг-уровни.                         | 
| `--reason`          | Показывать причину состояния порта.   | 
| `--open`            | Показывать только open/possibly open. | 
| `--packet-trace`    | Пакеты туда/обратно.                  | 
| `--iflist`          | Список интерфейсов/маршрутов.         | 
| `--log-errors`      | Лог ошибок в normal-вывод.            | 
| `--append-output`   | Дозапись в файлы.                     | 
| `--resume <file>`   | Продолжить прерванный скан.           | 
| `--stylesheet <pathurl>` | XSL для XML→HTML.                |  
| `--webxml`          | Референс на XSL на nmap.org.          | 
| `--no-stylesheet`   | Не ассоциировать XSL.                 | 

## Misc (прочее)

| Ключ                          | Описание                            |
| ----------------------------- | ----------------------------------- |
| `-6`                          | IPv6-сканирование.                  |
| `-A`                          | ОС + версии + скрипты + traceroute. |
| `--datadir <dir>`             | Своё расположение данных Nmap.      |
| `--send-eth/--send-ip`        | Отправка сырых Ethernet/IP пакетов. |
| `--privileged/--unprivileged` | Предположить права/их отсутствие.   |
| `-V`                          | Версия Nmap.                        |
| `-h`                          | Справка.                            |

## Примеры перечисления (Enumeration)

### NetBIOS

```
# Найти NetBIOS/SMB на подсети
nmap -sV -v -p 139,445 10.0.1.0/24
```
```
# Узнать NetBIOS-имя через nbstat
nmap -sU --script nbstat.nse -p 137 10.0.1.12
```

### Проверка MS08-067

```
# Осторожно: --script-args=unsafe=1 может уронить сервисы!
nmap --script-args=unsafe=1 --script smb-check-vulns.nse -p 445 10.0.0.1
```

### Тюнинг и оптимизация сканов

| Категория            | Параметр/ключ                                 | Назначение                                           | Пример                       | Заметки / Риски |
|----------------------|-----------------------------------------------|------------------------------------------------------|------------------------------|-----------------|
| Rate (скорость)      | `--max-rate <N>`                              | Ограничить верхнюю скорость пакетов (pkt/s)          | `--max-rate 500`             | Чем выше скорость, тем выше риск пропуска ответов/портов |
|                      | `--min-rate <N>`                              | Гарантировать минимальную скорость                   | `--min-rate 200`             | Может увеличить нагрузку на сеть/цель |
| Parallelism          | `--min-parallelism <N>` / `--max-parallelism <N>` | Контроль числа параллельных проб                    | `--min-parallelism 1`        | При срабатывании простых IDS снизьте `--min-parallelism` |
| Host Group Size      | `--min-hostgroup <N>` / `--max-hostgroup <N>` | Сколько хостов сканить одновременно                  | `--max-hostgroup 64`         | При `-oA` вывод появится после завершения всей группы |
| Host Timeout         | `--host-timeout <TIME>`                       | Прервать скан цели по истечении времени              | `--host-timeout 50s`         | Слишком малое значение → ложноотрицательные результаты |
| Scan Delay           | `--scan-delay <TIME>` / `--max-scan-delay <TIME>` | Пауза между пробами                                | `--scan-delay 5s`            | Для обхода блок-листов (например, `--scan-delay 1.2s` при лимите ~2 req/s) |
| DNS Lookup           | `-n`                                          | Отключить DNS-резолв для ускорения                   | `-n`                         | Меньше шума/быстрее, но без имён хостов |



