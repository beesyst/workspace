# SQL

## Оглавление

- [Учебные таблицы (для примеров)](#%D0%A3%D1%87%D0%B5%D0%B1%D0%BD%D1%8B%D0%B5-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%8B-%D0%B4%D0%BB%D1%8F-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D0%BE%D0%B2)
- [Базовый SELECT](#%D0%91%D0%B0%D0%B7%D0%BE%D0%B2%D1%8B%D0%B9-select)
- [Выбор столбцов и псевдонимы (AS)](#%D0%92%D1%8B%D0%B1%D0%BE%D1%80-%D1%81%D1%82%D0%BE%D0%BB%D0%B1%D1%86%D0%BE%D0%B2-%D0%B8-%D0%BF%D1%81%D0%B5%D0%B2%D0%B4%D0%BE%D0%BD%D0%B8%D0%BC%D1%8B-as)
- [Выражения и вычисляемые столбцы](#%D0%92%D1%8B%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B8-%D0%B2%D1%8B%D1%87%D0%B8%D1%81%D0%BB%D1%8F%D0%B5%D0%BC%D1%8B%D0%B5-%D1%81%D1%82%D0%BE%D0%BB%D0%B1%D1%86%D1%8B)
- [Фильтрация: WHERE](#%D0%A4%D0%B8%D0%BB%D1%8C%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F-where)
  - [Сравнения с числами](#%D0%A1%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F-%D1%81-%D1%87%D0%B8%D1%81%D0%BB%D0%B0%D0%BC%D0%B8)
  - [Сравнения со строками](#%D0%A1%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F-%D1%81%D0%BE-%D1%81%D1%82%D1%80%D0%BE%D0%BA%D0%B0%D0%BC%D0%B8)
  - [Даты и время](#%D0%94%D0%B0%D1%82%D1%8B-%D0%B8-%D0%B2%D1%80%D0%B5%D0%BC%D1%8F)
  - [Диапазоны: BETWEEN и альтернативы](#%D0%94%D0%B8%D0%B0%D0%BF%D0%B0%D0%B7%D0%BE%D0%BD%D1%8B-between-%D0%B8-%D0%B0%D0%BB%D1%8C%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%82%D0%B8%D0%B2%D1%8B)
  - [Комбинации условий: AND / OR / NOT](#%D0%9A%D0%BE%D0%BC%D0%B1%D0%B8%D0%BD%D0%B0%D1%86%D0%B8%D0%B8-%D1%83%D1%81%D0%BB%D0%BE%D0%B2%D0%B8%D0%B9-and--or--not)
  - [Частые предикаты: IN, LIKE, IS NULL](#%D0%A7%D0%B0%D1%81%D1%82%D1%8B%D0%B5-%D0%BF%D1%80%D0%B5%D0%B4%D0%B8%D0%BA%D0%B0%D1%82%D1%8B-in-like-is-null)
- [Сортировка и ограничение строк](#%D0%A1%D0%BE%D1%80%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0-%D0%B8-%D0%BE%D0%B3%D1%80%D0%B0%D0%BD%D0%B8%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D1%82%D1%80%D0%BE%D0%BA)
- [Полезные шаблоны](#%D0%9F%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D1%8B%D0%B5-%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B)
- [Памятка по кавычкам и экранированию](#%D0%9F%D0%B0%D0%BC%D1%8F%D1%82%D0%BA%D0%B0-%D0%BF%D0%BE-%D0%BA%D0%B0%D0%B2%D1%8B%D1%87%D0%BA%D0%B0%D0%BC-%D0%B8-%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8E)
- [Форматы дат/времени (MySQL)](#%D0%A4%D0%BE%D1%80%D0%BC%D0%B0%D1%82%D1%8B-%D0%B4%D0%B0%D1%82%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%B8-mysql)

---

## Учебные таблицы (для примеров)

| Таблица | Назначение | Важные поля (тип) | Пример строки |
|---|---|---|---|
| `good` | Товары и остатки | `id (INT)`, `name (VARCHAR)`, `count (INT)` | `(1, 'Keyboard', 42)` |
| `order_status` | Статусы заказов | `code (VARCHAR)`, `title (VARCHAR)` | `('NEW', 'Новый')` |
| ``order`` | Заказы | `id (INT)`, `creation_date (DATETIME)` | `(101, '2019-03-30 15:10:00')` |
| `user` | Пользователи | `id (INT)`, `name (VARCHAR)`, `reg_date (DATETIME)` | `(7, 'Ivan', '2021-09-08 08:12:01')` |

> Примечание: имена таблиц/полей в MySQL принято обрамлять обратными кавычками \`...\`, особенно если это зарезервированные слова (например, ``order``).

## Базовый SELECT

| Цель | Пример | Пояснение |
|---|---|---|
| Все столбцы из таблицы | `SELECT * FROM good;` | Самый простой запрос. |
| Конкретные столбцы | `SELECT id, name FROM good;` | Порядок столбцов задаете сами. |
| Ответ всегда - таблица | *(концепт)* | Может быть пустой, с любым числом строк/столбцов. |

## Выбор столбцов и псевдонимы (AS)

| Цель | Пример | Пояснение |
|---|---|---|
| Переименование столбца | `SELECT name AS product_name FROM good;` | Псевдонимы удобны в отчетах/витринах. |
| `AS` необязателен (MySQL) | `SELECT name product_name FROM good;` | Эквивалентно `AS`. |
| Несколько столбцов с псевдонимами | `SELECT id AS item_id, count AS qty FROM good;` | Читаемость ↑. |

## Выражения и вычисляемые столбцы

| Цель | Пример | Пояснение |
|---|---|---|
| Арифметика над полями | `SELECT (price * qty) AS total FROM cart;` | Любые +, -, *, /, функции. |
| Сумма двух полей | `SELECT (field1 + field2) AS total FROM tableName;` | Из материала урока. |
| Конкатенация строк (MySQL) | `SELECT CONCAT(first_name,' ',last_name) AS full_name FROM user;` | Для PostgreSQL: `first_name || ' ' || last_name`. |

## Фильтрация: WHERE

### Сравнения с числами

| Цель | Пример | Пояснение |
|---|---|---|
| Равно | ``SELECT id, name FROM `good` WHERE `count` = 0;`` | Все закончившиеся товары. |
| Неравно | ``SELECT * FROM `good` WHERE `count` != 0;`` | Альтернатива: `<>`. |
| Больше / меньше | ``SELECT * FROM `good` WHERE `count` < 10;`` | `<`, `>`, `<=`, `>=`. |
| Порог остатка | ``SELECT id, name FROM `good` WHERE `count` <= 50;`` | "Заканчиваются на складе". |

### Сравнения со строками

| Цель | Пример | Пояснение |
|---|---|---|
| Исключить значение | ``SELECT * FROM `order_status` WHERE `code` != 'NEW';`` | Строковые литералы - **в одинарных кавычках**. |
| Равно строке | ``SELECT * FROM `order_status` WHERE `code` = 'PAID';`` | Регистрозависимость зависит от collation. |

### Даты и время

| Цель | Пример | Пояснение |
|---|---|---|
| С даты и позже | ``SELECT id, name, reg_date FROM `user` WHERE `reg_date` >= '2019-01-01';`` | Достаточно даты без времени. |
| За конкретный день (MySQL) | ``SELECT id, creation_date FROM `order` WHERE DATE(creation_date) = '2019-03-30';`` | Удобно и читаемо. |
| Эквивалент «день целиком» | ``WHERE creation_date >= '2019-03-30 00:00:00' AND creation_date <= '2019-03-30 23:59:59'`` | Без `DATE()` - быстрее по индексу `creation_date` (при правильных границах). |

### Диапазоны: BETWEEN и альтернативы

| Цель | Пример | Эквивалент | Комментарий |
|---|---|---|---|
| Диапазон дат/времени | ``WHERE reg_date BETWEEN '2021-09-08 00:00:00' AND '2021-09-08 23:59:59'`` | ``reg_date >= '2021-09-08 00:00:00' AND reg_date <= '2021-09-08 23:59:59'`` | `BETWEEN` **включительно** по обеим границам. |
| Диапазон чисел | `WHERE count BETWEEN 1 AND 10` | `count >= 1 AND count <= 10` | То же правило включительности. |

### Комбинации условий: AND / OR / NOT

| Паттерн | Пример | Пояснение |
|---|---|---|
| Логическое И | `WHERE in_stock = 1 AND price < 1000` | Обе части должны быть истинны. |
| Логическое ИЛИ | `WHERE country = 'US' OR country = 'CA'` | Достаточно одной части. |
| Отрицание | `WHERE NOT (status = 'NEW')` | Эквивалент `status <> 'NEW'`. |
| Скобки | `WHERE (A OR B) AND C` | Явно задавайте приоритет. |

### Частые предикаты: IN, LIKE, IS NULL

| Цель | Пример | Пояснение |
|---|---|---|
| Множество значений | `WHERE code IN ('NEW','PAID','SHIPPED')` | Удобнее, чем цепочка `OR`. |
| Подстрока (MySQL) | `WHERE name LIKE 'Mac%'` | `%` - любой хвост, `_` - 1 символ. |
| Пустые значения | `WHERE comment IS NULL` | Не путать с пустой строкой `''`. |

## Сортировка и ограничение строк

| Цель | Пример | Пояснение |
|---|---|---|
| Сортировать по полю | `ORDER BY reg_date DESC` | `ASC` (по возрастанию) по умолчанию. |
| Композитная сортировка | `ORDER BY status ASC, reg_date DESC` | Сначала статус, затем дата. |
| Ограничить кол-во строк (MySQL) | `LIMIT 10 OFFSET 20` | 21–30-я строки результата. |
| Топ-N (классика) | `ORDER BY created_at DESC LIMIT 5` | Последние 5 записей. |

## Полезные шаблоны

| Задача | SQL |
|---|---|
| Все поля таблицы | `SELECT * FROM tableName;` |
| Только нужные поля | `SELECT field1, field2 FROM tableName;` |
| Псевдонимы столбцов | `SELECT field1 AS f1, field2 AS f2 FROM tableName;` |
| Вычисляемое поле | `SELECT (field1 + field2) AS total FROM tableName;` |
| Закончились товары | ``SELECT id, name FROM `good` WHERE `count` = 0;`` |
| Заканчиваются товары (порог) | ``SELECT id, name FROM `good` WHERE `count` <= 50;`` |
| Исключить статус `NEW` | ``SELECT * FROM `order_status` WHERE `code` != 'NEW';`` |
| Пользователи с 2019-01-01 | ``SELECT id, name, reg_date FROM `user` WHERE `reg_date` >= '2019-01-01';`` |
| Пользователи за день (границы) | ``SELECT * FROM `user` WHERE reg_date >= '2021-09-08 00:00:00' AND reg_date <= '2021-09-08 23:59:59';`` |
| Пользователи за день (`BETWEEN`) | ``SELECT * FROM `user` WHERE reg_date BETWEEN '2021-09-08 00:00:00' AND '2021-09-08 23:59:59';`` |

## Памятка по кавычкам и экранированию

| Что | Как писать | Почему |
|---|---|---|
| Имена таблиц/полей в MySQL | Обратные кавычки: ``SELECT `id` FROM `order`;`` | Защита от коллизий с ключевыми словами; сохранение регистра. |
| Строковые литералы | Одинарные кавычки: `'NEW'`, `'2019-03-30'` | Стандарт SQL. |
| Двойные кавычки в коде (Java и др.) | Экранировать: `\"NEW\"` | Иначе нарушите синтаксис строки в языке программирования. |

## Форматы дат/времени (MySQL)

| Тип | Формат | Пример |
|---|---|---|
| DATETIME | `YYYY-MM-DD HH:MM:SS` | `2021-01-30 22:45:07` |
| DATE | `YYYY-MM-DD` | `2021-01-30` |

> Рекомендация для производительности по индексам дат/времени: вместо `WHERE DATE(dt_col) = '2019-03-30'` по возможности используйте «дыдущие» границы:  
> `WHERE dt_col >= '2019-03-30 00:00:00' AND dt_col < '2019-03-31 00:00:00'`.

